# Beans GraphQL Schema

scalar Time

type Query {
  """
  Get a single bean by ID. Accepts either the full ID (e.g., "beans-abc1") or the short ID without prefix (e.g., "abc1").
  """
  bean(id: ID!): Bean

  """
  List beans with optional filtering
  """
  beans(filter: BeanFilter): [Bean!]!
}

type Mutation {
  """
  Create a new bean
  """
  createBean(input: CreateBeanInput!): Bean!

  """
  Update an existing bean
  """
  updateBean(id: ID!, input: UpdateBeanInput!): Bean!

  """
  Delete a bean by ID (automatically removes incoming links)
  """
  deleteBean(id: ID!): Boolean!

  """
  Set or clear the parent of a bean (validates type hierarchy)
  """
  setParent(id: ID!, parentId: String, ifMatch: String): Bean!

  """
  Add a bean to the blocking list
  """
  addBlocking(id: ID!, targetId: ID!, ifMatch: String): Bean!

  """
  Remove a bean from the blocking list
  """
  removeBlocking(id: ID!, targetId: ID!, ifMatch: String): Bean!

  """
  Add a bean to the blocked-by list (this bean is blocked by targetId)
  """
  addBlockedBy(id: ID!, targetId: ID!, ifMatch: String): Bean!

  """
  Remove a bean from the blocked-by list
  """
  removeBlockedBy(id: ID!, targetId: ID!, ifMatch: String): Bean!

  """
  Replace exactly one occurrence of text in a bean's body.
  Returns an error if the old text is not found or found multiple times.
  The new text can be empty to delete the matched text.
  """
  replaceInBody(id: ID!, old: String!, new: String!, ifMatch: String): Bean!

  """
  Append text to a bean's body with a blank line separator.
  If content is empty, this is a no-op and returns the bean unchanged.
  """
  appendToBody(id: ID!, content: String!, ifMatch: String): Bean!
}

"""
Input for creating a new bean
"""
input CreateBeanInput {
  "Bean title (required)"
  title: String!
  "Bean type (defaults to 'task')"
  type: String
  "Status (defaults to 'todo')"
  status: String
  "Priority level (defaults to 'normal')"
  priority: String
  "Tags for categorization"
  tags: [String!]
  "Markdown body content"
  body: String
  "Parent bean ID (validated against type hierarchy)"
  parent: String
  "Bean IDs this bean is blocking"
  blocking: [String!]
  "Bean IDs that are blocking this bean"
  blockedBy: [String!]
  "Custom ID prefix (overrides config prefix for this bean)"
  prefix: String
}

"""
Input for updating an existing bean
"""
input UpdateBeanInput {
  "New title"
  title: String
  "New status"
  status: String
  "New type"
  type: String
  "New priority"
  priority: String
  "Replace all tags (nil preserves existing)"
  tags: [String!]
  "New body content"
  body: String
  "ETag for optimistic concurrency control (optional)"
  ifMatch: String
}

"""
A bean represents an issue/task in the beans tracker
"""
type Bean {
  "Unique identifier (NanoID)"
  id: ID!
  "Human-readable slug from filename"
  slug: String
  "Relative path from .beans/ directory"
  path: String!
  "Bean title"
  title: String!
  "Current status (draft, todo, in-progress, completed, scrapped)"
  status: String!
  "Bean type (milestone, epic, bug, feature, task)"
  type: String!
  "Priority level (critical, high, normal, low, deferred)"
  priority: String!
  "Tags for categorization"
  tags: [String!]!
  "Creation timestamp"
  createdAt: Time!
  "Last update timestamp"
  updatedAt: Time!
  "Markdown body content"
  body: String!
  "Content hash for optimistic concurrency control"
  etag: String!

  # Direct link fields
  "Parent bean ID (optional, type-restricted)"
  parentId: String
  "IDs of beans this bean is blocking"
  blockingIds: [String!]!
  "IDs of beans that are blocking this bean (direct field)"
  blockedByIds: [String!]!

  # Computed relationship fields
  "Beans that block this one (incoming blocking links)"
  blockedBy(filter: BeanFilter): [Bean!]!
  "Beans this one is blocking (resolved from blockingIds)"
  blocking(filter: BeanFilter): [Bean!]!
  "Parent bean (resolved from parentId)"
  parent: Bean
  "Child beans (beans with this as parent)"
  children(filter: BeanFilter): [Bean!]!
}

"""
Filter options for querying beans
"""
input BeanFilter {
  """
  Full-text search across slug, title, and body using Bleve query syntax.

  Examples:
  - "login" - exact term match
  - "login~" - fuzzy match (1 edit distance)
  - "login~2" - fuzzy match (2 edit distance)
  - "log*" - wildcard prefix
  - "\"user login\"" - exact phrase
  - "user AND login" - both terms required
  - "user OR login" - either term
  - "slug:auth" - search only slug field
  - "title:login" - search only title field
  - "body:auth" - search only body field
  """
  search: String
  "Include only beans with these statuses (OR logic)"
  status: [String!]
  "Exclude beans with these statuses"
  excludeStatus: [String!]
  "Include only beans with these types (OR logic)"
  type: [String!]
  "Exclude beans with these types"
  excludeType: [String!]
  "Include only beans with these priorities (OR logic)"
  priority: [String!]
  "Exclude beans with these priorities"
  excludePriority: [String!]
  "Include only beans with any of these tags (OR logic)"
  tags: [String!]
  "Exclude beans with any of these tags"
  excludeTags: [String!]
  "Include only beans with a parent"
  hasParent: Boolean
  "Include only beans with this specific parent ID"
  parentId: String
  "Include only beans that are blocking other beans"
  hasBlocking: Boolean
  "Include only beans that are blocking this specific bean ID"
  blockingId: String
  "Include only beans that are blocked by others (via incoming blocking links or blocked_by field)"
  isBlocked: Boolean
  "Include only beans that have explicit blocked-by entries"
  hasBlockedBy: Boolean
  "Include only beans blocked by this specific bean ID (via blocked_by field)"
  blockedById: String
  "Exclude beans that have a parent"
  noParent: Boolean
  "Exclude beans that are blocking other beans"
  noBlocking: Boolean
  "Exclude beans that have explicit blocked-by entries"
  noBlockedBy: Boolean
}
