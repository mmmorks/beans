[tools]
go = "latest"
node = "latest"
svu = "latest"

[hooks]
postinstall = 'npx corepack enable'

[tasks.deps]
description = "Install all dependencies"
run = { tasks = ["deps:backend", "deps:frontend"] }

[tasks."deps:backend"]
description = "Install backend dependencies"
run = "go mod download"

[tasks."deps:frontend"]
description = "Install frontend dependencies"
dir = "frontend"
run = "pnpm install"

[tasks.codegen]
run = "go generate ./..."

[tasks.test]
depends = "codegen"
run = "go test ./..."

[tasks."build:frontend"]
description = "Build the SvelteKit frontend"
dir = "frontend"
run = "pnpm build"

[tasks."build:embed"]
description = "Copy frontend build to embed directory"
depends = "build:frontend"
run = """
rm -rf internal/web/dist
mkdir -p internal/web/dist
cp -r frontend/build/* internal/web/dist/
touch internal/web/dist/.gitkeep
"""

[tasks.build]
depends = ["codegen", "build:embed"]
run = """
go build -ldflags "\
  -X github.com/hmans/beans/cmd/beans.version=$(git describe --tags --always --dirty 2>/dev/null || echo dev) \
  -X github.com/hmans/beans/cmd/beans.commit=$(git rev-parse --short HEAD 2>/dev/null || echo unknown) \
  -X github.com/hmans/beans/cmd/beans.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  .
"""

[tasks.beans]
description = "Build and run the beans CLI"
run = "go run ."

[tasks.install]
depends = "build"
run = "cp beans ~/.local/bin/beans"

[tasks."release:patch"]
description = "Create a patch version tag (e.g., v0.1.4 → v0.1.5)"
run = """
set -e
NEW_VERSION=$(svu patch)
git tag "$NEW_VERSION"
echo "Created tag: $NEW_VERSION"
echo "To release, run: git push && git push --tags"
"""

[tasks."release:minor"]
description = "Create a minor version tag (e.g., v0.1.4 → v0.2.0)"
run = """
set -e
NEW_VERSION=$(svu minor)
git tag "$NEW_VERSION"
echo "Created tag: $NEW_VERSION"
echo "To release, run: git push && git push --tags"
"""

[tasks."release:major"]
description = "Create a major version tag (e.g., v0.1.4 → v1.0.0)"
run = """
set -e
NEW_VERSION=$(svu major)
git tag "$NEW_VERSION"
echo "Created tag: $NEW_VERSION"
echo "To release, run: git push && git push --tags"
"""


[tasks."dev:serve"]
run = "wgo run -exit . serve"

[tasks."dev:frontend"]
dir = "frontend"
run = "pnpm dev"

[tasks.dev]
description = "Run the development server"
run = { tasks = ["dev:serve", "dev:frontend"] }

[tasks."dev:kill"]
description = "Kill any lingering dev processes"
run = """
pkill -9 -f "beans serve" 2>/dev/null && echo "Killed beans serve processes" || echo "No beans serve processes"
pkill -9 -f "wgo.*beans" 2>/dev/null && echo "Killed wgo processes" || echo "No wgo processes"
"""
